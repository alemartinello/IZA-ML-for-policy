---
title: "replication of JAE 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preperation

Here I try to select the sample to replicate results in column 1 of table 1. My choice is based on the following description in the text:

*"After accessing the FARS data, we followed the description of how the author restricted the data as closely as possible.2 Owing to the number of restrictions imposed, we were unable to perfectly replicate the working dataset. While our total sample has 38,456 observations, his has only 37,635."*


and the table notes:

"Other controls in Levitt (2008)’ include the difference in weight of the cars, indicators for missing vehicle weight, of whether the driver had any major violations, of whether the speed limit on the road was less than or equal to 55 mph, of whether the crash occurred on a rural road, and of whether the crash occurred on a weekend, at night (8 pm to midnight), in the early morning (1–5 am)."



```{r }

# set working directory
setwd("/Users/hhs/Dropbox/Apps/Overleaf/IZA-ML-for-policy/Working example/JAE 2016")
# libraries
library("tidyverse")
library("policytree")
library("grf")
library("skimr")
# load data
df<-read_delim("FARS-data-full-sample.txt",delim = "\t")
# table 1 replication
df_1975_2003<-df%>%
              filter(year<2004,
                    !is.na(missweight),
                    !is.na(thoulbs_I),
                    !is.na(highviol),
                    !is.na(splmU55),
                    !is.na(ruralrd),
                    !is.na(weekend),
                    !is.na(lowviol),
                    !is.na(crashtm),
                    !is.na(childseat),
                    !is.na(lapbelt),
                    !is.na(lapshould),
                    !is.na(modelyr),
                    !is.na(age),
                    !is.na(male))
# n obs
nrow(df_1975_2003)

```

Interestingly I can't get the same number of obs as in the original paper. What am I missing?

## Replicate column (1) in table 1

Let's replicate the most simple regression in the paper

```{r }
# ols
lm<-lm(death~childseat+lapbelt+lapshould,data=df_1975_2003)
summary(lm)
```
 which is very similar to the paper!
 
## Causal forest

Okay, let's try the causal forest. But we use the multi-arm treatment, because it isn't clear what the treatment is. They are mainly comparing coefficients across the three types. 

```{r , echo=FALSE}
# treatment vector
W<-as.matrix(df_1975_2003%>%
              mutate(W=case_when(
                childseat==1~"Childseat",
                lapbelt==1~"Lapbelt",
                lapshould==1~"LapShoulderSeat",
                TRUE~"NONE"))%>%
               select(W))
W<-factor(W,levels=c("NONE","Lapbelt","LapShoulderSeat","Childseat"))
# Vector of covariates
X<-as.matrix(df_1975_2003%>%
            select(modelyr,thoulbs_I,age,male,splmU55))
# Outcome vector
Y<-as.matrix(df_1975_2003%>%
               select(death))

# Estimate CF
cf <- multi_arm_causal_forest(X, Y, W)
```

Histogram of treatment effects

```{r , echo=FALSE}
tauhat <- predict(cf)$predictions[,,]
df_1<-data.frame(tauhat=tauhat[,"Lapbelt - NONE"],type="Lapbelt - NONE")
df_2<-data.frame(tauhat=tauhat[,"LapShoulderSeat - NONE"],type="LapShoulderSeat - NONE")
df_3<-data.frame(tauhat=tauhat[,"Childseat - NONE"],type="Childseat - NONE")
df_chart<-rbind(df_1,df_2,df_3)

ggplot(df_chart,aes(x=tauhat,fill=type,color=type))+geom_density(alpha=0.8)
```

Average treatment effects (doubly robust)

```{r , echo=FALSE}
average_treatment_effect(cf)
```

How does cate vary by age?

```{r , echo=FALSE}
tauhat <- predict(cf)$predictions[,,]
df_1<-data.frame(tauhat=tauhat[,"Lapbelt - NONE"],type="Lapbelt - NONE",age=df_1975_2003$age)
df_2<-data.frame(tauhat=tauhat[,"LapShoulderSeat - NONE"],type="LapShoulderSeat - NONE",age=df_1975_2003$age)
df_3<-data.frame(tauhat=tauhat[,"Childseat - NONE"],type="Childseat - NONE",age=df_1975_2003$age)
df_chart<-rbind(df_1,df_2,df_3)%>%
  group_by(age,type)%>%summarise(tauhat=mean(tauhat))

ggplot(df_chart,aes(x=age,y=tauhat,fill=type,color=type))+geom_line()
```


Optimal policy
```{r , echo=FALSE}
skim(X)
```

```{r , echo=FALSE}

Gamma.matrix <- double_robust_scores(cf)
opt.tree <- policy_tree(X,Gamma.matrix, depth = 2)
opt.tree
```


