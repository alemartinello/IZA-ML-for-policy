---
title: "replication of JAE 2016"
output:
  html_document:
    df_print: paged
---

## Preperation

Here I try to select the sample to replicate results in column 1 of table 1. My choice is based on the following description in the text:

*"After accessing the FARS data, we followed the description of how the author restricted the data as closely as possible.2 Owing to the number of restrictions imposed, we were unable to perfectly replicate the working dataset. While our total sample has 38,456 observations, his has only 37,635."*


and the table notes:

"Other controls in Levitt (2008)’ include the difference in weight of the cars, indicators for missing vehicle weight, of whether the driver had any major violations, of whether the speed limit on the road was less than or equal to 55 mph, of whether the crash occurred on a rural road, and of whether the crash occurred on a weekend, at night (8 pm to midnight), in the early morning (1–5 am)."




```{r }
# libraries
library("tidyverse")
library("patchwork")
library("policytree")
library("grf")
library("flextable")
library("modelsummary")
library("fixest")
library("skimr")
# load data
df<-read_delim("../data/FARS-data-full-sample.txt",delim = "\t")
# select sample
df_1975_2003<-df%>%
              filter(year<2004)%>%
              select(-starts_with("imp"))
# remove missing obs with missing values
df_1975_2003<-df_1975_2003[complete.cases(df_1975_2003), ]
          
# n obs
nrow(df_1975_2003)

```

Autsch. 1 obs off! Let's move on. 


## Replicating results from table 1

Let's replicate the most simple regression in the paper

```{r }
# column (1) in table 1
col1<-feols(death~childseat+lapbelt+lapshould,cluster=c("crashcar"),data=df_1975_2003)
# column (2) in table 1
col2<-feols(death~childseat+lapbelt+lapshould+
          thoulbs_I+missweight+highviol+lowviol+splmU55+ruralrd+weekend+factor(crashtm)+
          backright+backleft+row1+factor(age)+male+drivebelt+lsimp+rsimp+indrearimp+rearimp+
          indfrimp+frimp+factor(modelyr)                
          |year,cluster=c("crashcar"),data=df_1975_2003)
# generate table
cm <- c('lapshould'    = 'Lap and shoulder seat',
        'lapbelt'    = 'Lap-only belt',
        'childseat' = 'Child seat')

modelsummary(list(col1,col2), stars = TRUE,statistic = 'std.error',
             fmt= '%.4f', coef_map = cm,output = 'flextable')

```

Close, but not perfect!


## Train causal forests

We use the multi-arm treatment.

```{r }
# treatment vector
Wmulti<-as.matrix(df_1975_2003%>%
              mutate(W=case_when(
                childseat==1~"Childseat",
                lapbelt==1~"Lapbelt",
                lapshould==1~"LapShoulderSeat",
                TRUE~"NONE"))%>%
               select(W))
Wmulti<-factor(Wmulti,levels=c("NONE","Lapbelt","LapShoulderSeat","Childseat"))

W<-as.matrix(df_1975_2003%>%
              mutate(W=case_when(
                childseat==1~1,
                lapbelt==1~1,
                lapshould==1~1,
                TRUE~0))%>%
               select(W))
# Vector of covariates
X<-as.matrix(df_1975_2003%>%
            select( highviol,lowviol,splmU55,ruralrd,weekend,
          backright,backleft,row1,age,male,lsimp,rsimp,indrearimp,rearimp,
          indfrimp,frimp,modelyr,year))
# Outcome vector
Y<-as.matrix(df_1975_2003%>%
               select(death))
# Estimate CF multiarm
cfmulti <- multi_arm_causal_forest(X, Y, Wmulti)
# Estimate CF
cf <- causal_forest(X, Y, W)
```

## Assess "fit"


### Propensity scores

#### Single treatment 

```{r , }
plotdata<-data.frame(what=cf$W.hat)
ggplot(plotdata,aes(x=what))+
  geom_histogram(aes(x = what, y = ..density..),
                  color="white",fill="#3aab54",bins=50)+
  xlim(0,1)+
  theme_minimal()

```

#### Multiarm treatment 

```{r , }
plotdata<-data.frame(what=cfmulti$W.hat)%>%
    pivot_longer(cols=2:4,names_to="type",values_to="value")
ggplot(plotdata)+
  geom_histogram(aes(x = value, y = ..density..),
                  color="white",fill="#3aab54",bins=50)+
  xlim(0,1)+
  theme_minimal()+
    facet_wrap(~type,ncol=1)


```

### Common support

#### Single treatment

```{r , }
IPW <- ifelse(W == 1, 1 / cf$W.hat, 1 / (1 - cf$W.hat))

plotdata<-data.frame(W,IPW=IPW,X)%>%
  pivot_longer(cols=3:ncol(plotdata),names_to="var",values_to="val")


ggplot(plotdata, aes(x = val, weight = W.1, fill = as.factor(W))) +
  geom_histogram(alpha = 0.75,binwidth=1, position = position_dodge2())+
  facet_wrap( ~ var,ncol=6, scales="free_x")+theme_minimal()+
  theme(legend.pos="top")+labs(fill="Treated",x="Value", y="Freq")
```



##  Diagnostic test

this only works for the single treatment specification

```{r , echo=FALSE}
test_calibration(cf)
```



##  Histogram of treatment effects

### Single treatment

```{r , echo=FALSE}
df_tauhat<-data.frame(tauhat=predict(cf)$predictions)
ggplot(df_tauhat,aes(x=tauhat))+  
   geom_histogram(aes(x = tauhat, y = ..density..),
                  color="white",fill="#3aab54",bins=50) +
   theme_minimal()+
  theme(legend.position = "none")
```

### Multiarm treatment 

```{r , echo=FALSE}
tauhat <- predict(cfmulti)$predictions[,,]
df_1<-data.frame(tauhat=tauhat[,"Lapbelt - NONE"],type="Lapbelt - NONE")
df_2<-data.frame(tauhat=tauhat[,"LapShoulderSeat - NONE"],type="LapShoulderSeat - NONE")
df_3<-data.frame(tauhat=tauhat[,"Childseat - NONE"],type="Childseat - NONE")
df_chart<-rbind(df_1,df_2,df_3)

ggplot(df_chart,aes(x=tauhat))+  
   geom_histogram(aes(x = tauhat, y = ..density..),
                  color="white",fill="#3aab54",bins=50) +
   facet_wrap(~type,ncol=1)+
   theme_minimal()+
   labs(fill="",color="")+
  theme(legend.position = "none")
```



##  Average treatment effects (doubly robust)

### Single treatment 

```{r , echo=FALSE}
average_treatment_effect(cf)
```


### Multiarm treatment 

```{r , echo=FALSE}
average_treatment_effect(cfmulti)
```


##  How does cate vary by age and year?


### Single treatment

```{r , echo=FALSE}

df_chart<-data.frame(tauhat=predict(cf)$predictions,
                age=df_1975_2003$age,
                year=df_1975_2003$year)%>%
  group_by(age)%>%summarise(tauhat=mean(tauhat))

p1<-ggplot(df_chart,aes(x=age,y=tauhat))+
  geom_line(size=2)+
  geom_point(size=3)+
   theme_minimal()+
   labs(fill="",color="")

df_chart<-data.frame(tauhat=predict(cf)$predictions,
                age=df_1975_2003$age,year=df_1975_2003$year)%>%
  group_by(year)%>%summarise(tauhat=mean(tauhat))

p2<-ggplot(df_chart,aes(x=year,y=tauhat))+
  geom_line(size=2)+
  geom_point(size=3)+
   theme_minimal()+
   labs(fill="",color="")
p1+p2
```

### Multiarm

```{r , echo=FALSE}
tauhat <- predict(cfmulti)$predictions[,,]
df_1<-data.frame(tauhat=tauhat[,"Lapbelt - NONE"],type="Lapbelt - NONE",age=df_1975_2003$age,year=df_1975_2003$year)
df_2<-data.frame(tauhat=tauhat[,"LapShoulderSeat - NONE"],type="LapShoulderSeat - NONE",age=df_1975_2003$age,year=df_1975_2003$year)
df_3<-data.frame(tauhat=tauhat[,"Childseat - NONE"],type="Childseat - NONE",age=df_1975_2003$age,year=df_1975_2003$year)
df_chart<-rbind(df_1,df_2,df_3)%>%
  group_by(age,type)%>%summarise(tauhat=mean(tauhat))

p1<-ggplot(df_chart,aes(x=age,y=tauhat,fill=type,color=type))+
  geom_line(size=2)+
  geom_point(size=3)+
   theme_minimal()+
   labs(fill="",color="")+
  theme(legend.position = "none")

df_chart<-rbind(df_1,df_2,df_3)%>%
  group_by(year,type)%>%summarise(tauhat=mean(tauhat))

p2<-ggplot(df_chart,aes(x=year,y=tauhat,fill=type,color=type))+
  geom_line(size=2)+
  geom_point(size=3)+
   theme_minimal()+
   labs(fill="",color="")+
  theme(legend.position = "top")
p1+p2
```



## Optimal policy

### Single treatment

```{r , echo=FALSE}

Gamma.matrix <- double_robust_scores(cf)
opt.tree <- policy_tree(X,Gamma.matrix, depth = 2)
opt.tree
```

```{r , echo=FALSE}

Gamma.matrix <- double_robust_scores(cf)
opt.tree <- policy_tree(X,Gamma.matrix, depth = 2)
plot(opt.tree)
```


### Multiarm

```{r , echo=FALSE}

Gamma.matrix <- double_robust_scores(cfmulti)
opt.tree <- policy_tree(X,Gamma.matrix, depth = 2)
opt.tree
```

```{r , echo=FALSE}

Gamma.matrix <- double_robust_scores(cfmulti)
opt.tree <- policy_tree(X,Gamma.matrix, depth = 2)
plot(opt.tree)
```


